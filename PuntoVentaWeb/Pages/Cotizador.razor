@page "/cotizacion"
@page "/cotizacion/editar/{Id:int}"
@page "/cotizacion/copiar/{IdCopiar:int}"
@using PuntoVentaWeb.Models
@using PuntoVentaWeb.Services

@inject ClienteService _clienteService
@inject CotizacionService _cotizacionService
@inject IJSRuntime JS
@inject EmailService _emailService
@inject NavigationManager Navigation

<div class="container-fluid pb-5">
    <div class="card mb-3 border-primary">
        <div class="card-header bg-light d-flex justify-content-between align-items-center"
             style="cursor: pointer;"
             @onclick="() => datosGeneralesAbiertos = !datosGeneralesAbiertos">

            <strong>1. Datos Generales y Cliente</strong>

            <div class="d-flex align-items-center">
                @if (!datosGeneralesAbiertos)
                {
                    <span class="badge bg-success me-3">
                        @if (nuevaCotizacion.ClienteId > 0)
                        {
                            @nuevaCotizacion.ClienteNombre
                        }
                        else
                        {
                            <text>Público General</text>
                        }
                    </span>
                }
                <i class="oi @(datosGeneralesAbiertos ? "oi-chevron-top" : "oi-chevron-bottom")"></i>
            </div>
        </div>

        <div class="card-body @(datosGeneralesAbiertos ? "" : "d-none")">
            <div class="row align-items-center">
                @* Buscador de Cliente *@
                <div class="col-md-6 position-relative">
                    <label class="form-label">Buscar Cliente:</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="oi oi-person"></i></span>
                        <input type="text"
                               class="form-control"
                               placeholder="Escribe nombre o RFC..."
                               @bind="busquedaCliente"
                               @bind:event="oninput"
                               @onkeyup="BuscarClienteEnTiempoReal" />

                        <button class="btn btn-primary" title="Nuevo Cliente" @onclick="() => mostrarModalCliente = true">
                            <i class="oi oi-plus"></i>
                        </button>
                    </div>
                    @if (mostrarListaClientes && listaClientes != null && listaClientes.Count > 0)
                    {
                        <div class="list-group position-absolute shadow w-100" style="z-index: 1000; top: 75px; max-height: 200px; overflow-y: auto;">
                            @foreach (var c in listaClientes)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick="() => SeleccionarCliente(c)">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@c.Nombre</h6>
                                        <small class="text-muted">ID: @c.Id</small>
                                    </div>
                                    <small class="text-muted">RFC: @c.RFC | Tel: @c.Telefono</small>
                                </button>
                            }
                        </div>
                    }
                </div>

                <div class="col-md-6">
                    <label class="form-label">Cliente Seleccionado:</label>
                    <div class="input-group">
                        <input type="text" class="form-control fw-bold text-success"
                               value="@(nuevaCotizacion.ClienteId > 0 ? $"{nuevaCotizacion.ClienteNombre} (ID: {nuevaCotizacion.ClienteId})" : "Público General")"
                               readonly />

                        <button class="btn btn-outline-danger" type="button"
                                title="Quitar cliente y volver a Público General"
                                disabled="@(nuevaCotizacion.ClienteId == 0)"
                                @onclick="LimpiarCliente">
                            <span class="oi oi-trash"></span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <label class="form-label">Observaciones / Notas:</label>
                    <textarea class="form-control"
                              @bind="nuevaCotizacion.Observaciones"
                              rows="1"
                              placeholder="Ej: Entregar a domicilio, pago pendiente, etc..."></textarea>
                </div>
            </div>

            @* --- NUEVO: SECCIÓN DINÁMICA DE DATOS --- *@
            @if (nuevaCotizacion.DatosDinamicos != null && nuevaCotizacion.DatosDinamicos.Any())
            {
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-12 mb-2">
                        <h6 class="text-primary"><i class="oi oi-list"></i> Datos Adicionales de Cotización</h6>
                    </div>
                    @foreach (var dato in nuevaCotizacion.DatosDinamicos)
                    {
                        <div class="col-md-4 mb-2">
                            <label class="form-label small fw-bold">@dato.Etiqueta:</label>
                            <input type="text" class="form-control form-control-sm"
                                   @bind="dato.Valor"
                                   placeholder="Ingrese @dato.Etiqueta..." />
                        </div>
                    }
                </div>
            }
            @* ---------------------------------------- *@
        </div>
    </div>

    @* Secciones de Productos y Detalle (Sin cambios mayores) *@
    <div class="row">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    Buscador de Productos
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" @bind="terminoBusqueda" @onkeyup="@(e => { if (e.Key == "Enter") Buscar(); })" placeholder="Código o Nombre..." />
                        <button class="btn btn-secondary" @onclick="Buscar">Buscar</button>
                    </div>

                    @if (resultadosBusqueda != null && resultadosBusqueda.Count > 0)
                    {
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Desc</th>
                                        <th>$ Público</th>
                                        <th>$ Mayoreo</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var prod in resultadosBusqueda)
                                    {
                                        <tr @onclick="() => PrepararProducto(prod)" style="cursor: pointer; background-color: @(productoSeleccionado == prod ? "#e9ecef" : "white")">
                                            <td>
                                                <strong>@prod.Nombre</strong><br />
                                                <small class="text-muted">Cod: @prod.Id | Stock: @prod.Existencia</small>
                                            </td>
                                            <td class="text-end">@prod.Precioventa.ToString("C2")</td>
                                            <td class="text-end">@prod.PrecioventaMayoreo.ToString("C2")</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">→</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else if (busquedaRealizada)
                    {
                        <div class="alert alert-warning">No se encontraron productos.</div>
                    }

                    @if (productoSeleccionado != null)
                    {
                        <div class="border p-3 mt-3 bg-light rounded">
                            <h5>Agregar: @productoSeleccionado.Nombre</h5>
                            <div class="row g-2">
                                <div class="col-4">
                                    <label>Cantidad:</label>
                                    <input type="number" class="form-control" @bind="cantidadAgregar" min="1" />
                                </div>

                                <div class="col-8">
                                    <label>Precio Unitario:</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control fw-bold"
                                               @bind="precioManual"
                                               step="0.01" />
                                    </div>
                                    <div class="mt-1 text-end">
                                        <span class="text-muted small me-2">Ref:</span>
                                        <button class="btn btn-xs btn-outline-secondary" style="font-size:0.7rem;"
                                                @onclick="() => precioManual = Math.Round(productoSeleccionado.Precioventa, 2)">
                                            Púb: @productoSeleccionado.Precioventa.ToString("C2")
                                        </button>

                                        <button class="btn btn-xs btn-outline-secondary" style="font-size:0.7rem;"
                                                @onclick="() => precioManual = Math.Round(productoSeleccionado.PrecioventaMayoreo, 2)">
                                            May: @productoSeleccionado.PrecioventaMayoreo.ToString("C2")
                                        </button>
                                    </div>
                                </div>

                                <div class="col-12 mt-2">
                                    <button class="btn btn-primary w-100" @onclick="AgregarAlCarrito">Agregar a la Cotización</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    Detalle de Cotización
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-striped mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th style="width: 70px;">Cant</th>
                                    <th>Producto</th>
                                    <th style="width: 120px;">P. Unit</th>
                                    <th>Importe</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in nuevaCotizacion.Detalles)
                                {
                                    <tr>
                                        <td>
                                            <input type="number" class="form-control form-control-sm"
                                                   value="@item.Cantidad"
                                                   @onchange="@(e => ActualizarLinea(item, e.Value, item.PrecioUnitario))"
                                                   min="1" />
                                        </td>
                                        <td>
                                            @if (item.ProductoCodigo == "0")
                                            {
                                                <textarea class="form-control form-control-sm"
                                                          @bind="item.Descripcion"
                                                          rows="2"
                                                          placeholder="Escribe descripción..."></textarea>
                                            }
                                            else
                                            {
                                                @item.Descripcion <br />
                                                <small class="text-muted">@item.ProductoCodigo</small>
                                            }
                                        </td>
                                        <td>
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control"
                                                       value="@item.PrecioUnitario"
                                                       step="0.01"
                                                       @onchange="@(e => ActualizarLinea(item, item.Cantidad, e.Value))" />
                                            </div>
                                        </td>
                                        <td class="text-end">@item.Importe.ToString("C2")</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-danger" @onclick="() => EliminarDelCarrito(item)">X</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <h4>Subtotal: @nuevaCotizacion.Total.ToString("C2")</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4 mb-5">
        <div class="col-12">
            <div class="card shadow-sm border-success">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0 text-success">Total Final: @nuevaCotizacion.Total.ToString("C2")</h3>
                        <small class="text-muted">Verifique los datos antes de guardar.</small>
                    </div>

                    <button class="btn btn-lg @(Id.HasValue ? "btn-warning" : "btn-success") px-5" @onclick="GuardarEnBaseDatos">
                        <i class="oi @(Id.HasValue ? "oi-pencil" : "oi-check") me-2"></i> 
                        @(Id.HasValue ? "Actualizar Cotización" : "Guardar Cotización")
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@if (mostrarModalCliente)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">Registrar Cliente Rápido</h5>
                    <button type="button" class="btn-close" @onclick="() => mostrarModalCliente = false"></button>
                </div>
                <div class="modal-body">
                    <FormularioCliente OnClienteGuardado="AlCrearCliente"
                                       OnCancelar="() => mostrarModalCliente = false"
                                       ShowCancelButton="true" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }
    [Parameter] public int? IdCopiar { get; set; }
    private bool datosGeneralesAbiertos = true;
    private string busquedaCliente = "";
    private List<Cliente> listaClientes = new List<Cliente>();
    private bool mostrarListaClientes = false;
    private bool mostrarModalCliente = false;
    private string clienteEmailSeleccionado = "";

    // Estado de configuración
    private List<string> configuracionCampos = new List<string>();

    // Variables de Estado
    private Cotizacion nuevaCotizacion = new Cotizacion();
    private List<Producto> resultadosBusqueda = new List<Producto>();
    private string terminoBusqueda = "";
    private bool busquedaRealizada = false;
    private Producto productoSeleccionado;
    private int cantidadAgregar = 1;
    private decimal precioManual = 0;

    // --- NUEVO: Inicialización del componente ---
 protected override async Task OnInitializedAsync()
{
    configuracionCampos = await _cotizacionService.ObtenerConfiguracionCampos();

    if (IdCopiar.HasValue) // Verificamos si hay un ID para copiar
    {
        // Pasamos IdCopiar.Value (int) en lugar de IdCopiar (int?)
        var cotizacionExistente = await _cotizacionService.ObtenerCotizacionPorId(IdCopiar.Value);
        
        if (cotizacionExistente != null)    
        {
            // Inicializamos para que traiga los campos dinámicos vacíos primero
            await InicializarCotizacion(); 

            // Clonamos solo los productos
            nuevaCotizacion.Detalles = cotizacionExistente.Detalles.Select(d => new DetalleCotizacion {
                ProductoCodigo = d.ProductoCodigo,
                Descripcion = d.Descripcion,
                Cantidad = d.Cantidad,
                PrecioUnitario = d.PrecioUnitario
            }).ToList();
        }
    }
    else if (Id.HasValue) // MODO EDICIÓN
    {
        // Pasamos Id.Value (int) en lugar de Id (int?)
        var cotExistente = await _cotizacionService.ObtenerCotizacionPorId(Id.Value);
        
        if (cotExistente != null)
        {
            nuevaCotizacion = cotExistente;
            if (nuevaCotizacion.ClienteId > 0)
            {
                var c = await _clienteService.ObtenerClientePorId(nuevaCotizacion.ClienteId);
                clienteEmailSeleccionado = c?.Correo ?? "";
            }
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "No se encontró la cotización.");
            Navigation.NavigateTo("/cotizacion");
        }
    }
    else // MODO NUEVO
    {
        await InicializarCotizacion();
    }
}

    // --- NUEVO: Método helper para resetear el formulario con campos dinámicos ---
    private async Task InicializarCotizacion()
    {
        nuevaCotizacion = new Cotizacion();

        // Agregamos los items vacíos para que el HTML los pinte
        if (configuracionCampos != null)
        {
            foreach (var campo in configuracionCampos)
            {
                nuevaCotizacion.DatosDinamicos.Add(new DatoDinamicoItem { Etiqueta = campo, Valor = "" });
            }
        }
    }

    private void AlCrearCliente(Cliente nuevoCliente)
    {
        mostrarModalCliente = false;
        SeleccionarCliente(nuevoCliente);
        busquedaCliente = nuevoCliente.Nombre;
    }

    private async Task BuscarClienteEnTiempoReal()
    {
        if (busquedaCliente.Length > 2)
        {
            listaClientes = await _cotizacionService.BuscarClientes(busquedaCliente);
            mostrarListaClientes = true;
        }
        else
        {
            listaClientes.Clear();
            mostrarListaClientes = false;
        }
    }

    private void SeleccionarCliente(Cliente c)
    {
        nuevaCotizacion.ClienteId = c.Id;
        nuevaCotizacion.ClienteNombre = c.Nombre;
        clienteEmailSeleccionado = c.Correo;
        busquedaCliente = "";
        mostrarListaClientes = false;
    }

    private async Task Buscar()
    {
        if (string.IsNullOrWhiteSpace(terminoBusqueda)) return;

        if (terminoBusqueda.Trim() == "0")
        {
            var detalle = new DetalleCotizacion
            {
                ProductoCodigo = "0",
                Descripcion = "PRODUCTO GENERICO",
                Cantidad = 1,
                PrecioUnitario = 0
            };
            nuevaCotizacion.Detalles.Add(detalle);
            terminoBusqueda = "";
            productoSeleccionado = null;
            resultadosBusqueda.Clear();
            busquedaRealizada = false;
            return;
        }

        busquedaRealizada = true;
        productoSeleccionado = null;
        resultadosBusqueda = await _cotizacionService.BuscarProductos(terminoBusqueda);
    }

    private void PrepararProducto(Producto prod)
    {
        if (prod.Id == "0")
        {
            var detalle = new DetalleCotizacion
            {
                ProductoCodigo = "0",
                Descripcion = "PRODUCTO GENERICO",
                Cantidad = 1,
                PrecioUnitario = 0
            };
            nuevaCotizacion.Detalles.Add(detalle);
            productoSeleccionado = null;
            terminoBusqueda = "";
            resultadosBusqueda.Clear();
        }
        else
        {
            productoSeleccionado = prod;
            cantidadAgregar = 1;
            precioManual = Math.Round(prod.Precioventa, 2);
        }
    }

    private void AgregarAlCarrito()
    {
        if (productoSeleccionado == null) return;
        if (cantidadAgregar <= 0) return;

        decimal precioFinal = precioManual;

        var detalle = new DetalleCotizacion
        {
            ProductoCodigo = productoSeleccionado.Id,
            Descripcion = productoSeleccionado.Nombre,
            Cantidad = cantidadAgregar,
            PrecioUnitario = precioFinal
        };

        nuevaCotizacion.Detalles.Add(detalle);
        productoSeleccionado = null;
        terminoBusqueda = "";
        resultadosBusqueda.Clear();
    }

    private void ActualizarLinea(DetalleCotizacion item, object cantObj, object precioObj)
    {
        if (int.TryParse(cantObj.ToString(), out int c) && c > 0) item.Cantidad = c;
        if (decimal.TryParse(precioObj.ToString(), out decimal p) && p >= 0) item.PrecioUnitario = p;
    }

    private void EliminarDelCarrito(DetalleCotizacion item)
    {
        nuevaCotizacion.Detalles.Remove(item);
    }

    private async Task GuardarEnBaseDatos()
    {
        if (nuevaCotizacion.Detalles.Count == 0)
        {
            await JS.InvokeVoidAsync("alert", "La cotización está vacía.");
            return;
        }

        try
        {
            if (Id.HasValue)
            {
                // LÓGICA DE ACTUALIZACIÓN
                await _cotizacionService.ActualizarCotizacion(nuevaCotizacion);
                await JS.InvokeVoidAsync("alert", "¡Cotización Actualizada Exitosamente!");
            }
            else
            {
                // LÓGICA DE GUARDADO NUEVO
                await _cotizacionService.GuardarCotizacion(nuevaCotizacion);
                int nuevoFolio = await _cotizacionService.ObtenerUltimoFolio();
                nuevaCotizacion.Id = nuevoFolio;
                await JS.InvokeVoidAsync("alert", "¡Cotización Guardada Exitosamente!");
            }

            // Preguntar por envío de correo
            if (!string.IsNullOrEmpty(clienteEmailSeleccionado))
            {
                bool deseaEnviar = await JS.InvokeAsync<bool>("confirm",
                    $"¿Deseas enviar (o re-enviar) la cotización a: {clienteEmailSeleccionado}?");

                if (deseaEnviar)
                {
                    await EnviarCorreoAutomatico(nuevaCotizacion.Id);
                }
            }

            // Después de editar o guardar, lo mejor es limpiar o volver al historial
            Navigation.NavigateTo("/historial");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Error al procesar: " + ex.Message);
        }
    }

    private async Task EnviarCorreoAutomatico(int folio)
    {
        try
        {
            await JS.InvokeVoidAsync("alert", "Generando PDF y enviando correo, por favor espera...");
            var config = await _cotizacionService.ObtenerConfiguracion();
            Cliente clienteParaPdf = null;
            if (nuevaCotizacion.ClienteId > 0)
            {
                clienteParaPdf = await _clienteService.ObtenerClientePorId(nuevaCotizacion.ClienteId);
            }
            var pdfBytes = PdfGenerator.CrearPdfCotizacion(nuevaCotizacion,clienteParaPdf, config);
            
            var resultado = await _emailService.EnviarCotizacionConPdf(
                clienteEmailSeleccionado,
                nuevaCotizacion.ClienteNombre,
                $"Cotización #{folio} - {config.NombreLugar}",
                pdfBytes,
                folio
            );

            if (resultado.Exito)
            {
                await JS.InvokeVoidAsync("alert", "¡Correo enviado correctamente!");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "La cotización se guardó, pero hubo un error al enviar el correo: " + resultado.Mensaje);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.ToString());
            await JS.InvokeVoidAsync("alert", "Error técnico enviando correo.");
        }
    }

    private void LimpiarCliente()
    {
        nuevaCotizacion.ClienteId = 0;
        nuevaCotizacion.ClienteNombre = "";
        clienteEmailSeleccionado = "";
        busquedaCliente = "";
    }
}