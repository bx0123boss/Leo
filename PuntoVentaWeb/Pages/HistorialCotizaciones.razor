@page "/historial"
@using PuntoVentaWeb.Services
@using PuntoVentaWeb.Models
@using System.IO
@inject CotizacionService _cotizacionService
@inject ClienteService _clienteService
@inject EmailService _emailService
@inject IJSRuntime JS

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Historial de Cotizaciones</h3>
        <a href="/cotizacion" class="btn btn-primary">
            <i class="oi oi-plus"></i> Nueva Cotización
        </a>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="oi oi-magnifying-glass"></i></span>
                <input type="text"
                       class="form-control"
                       placeholder="Buscar por Folio o Nombre del Cliente..."
                       @bind-value="terminoBusqueda"
                       @bind-value:event="oninput" />
            </div>
        </div>
    </div>
    @if (cargando)
    {
        <div class="alert alert-info">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Cargando datos...
        </div>
    }
    else if (listaCotizaciones == null || listaCotizaciones.Count == 0)
    {
        <div class="alert alert-warning">No hay cotizaciones registradas en SQL Server.</div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Folio</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Observaciones</th>
                                <th class="text-end">Total</th>
                                <th class="text-center" style="width: 180px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cot in CotizacionesFiltradas.Skip((paginaActual - 1) * elementosPorPagina).Take(elementosPorPagina))
                            {
                                <tr>
                                    <td><strong>#@cot.Id</strong></td>
                                    <td>@cot.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@cot.ClienteNombre</td>

                                    <td>
                                        @if (!string.IsNullOrEmpty(cot.Observaciones))
                                        {
                                            <span title="@cot.Observaciones" class="d-inline-block text-truncate" style="max-width: 250px;">
                                                @cot.Observaciones
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small fst-italic">Sin observaciones</span>
                                        }
                                    </td>

                                    <td class="text-end text-success fw-bold">@cot.Total.ToString("C2")</td>

                                    <td class="text-center">
                                        <a href="/cotizacion/@cot.Id" class="btn btn-sm btn-outline-secondary me-1" title="Ver Detalles">
                                            <i class="oi oi-eye"></i>
                                        </a>

                                        <button class="btn btn-sm btn-outline-danger" title="Descargar PDF" @onclick="() => DescargarPdfDesdeLista(cot.Id)">
                                            <i class="oi oi-print"></i> PDF
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary ms-1"
                                                title="Enviar por Correo"
                                                @onclick="() => PrepararEnvioCorreo(cot)">
                                            <i class="oi oi-envelope-closed"></i>
                                        </button>
                                    </td>
                                </tr>
                            }

                            @if (CotizacionesFiltradas.Count == 0)
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">
                                        No se encontraron resultados para "@terminoBusqueda"
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer d-flex justify-content-between align-items-center">
                <span class="text-muted small">
                    Mostrando @(CotizacionesFiltradas.Count == 0 ? 0 : (paginaActual - 1) * elementosPorPagina + 1)
                    a @Math.Min(paginaActual * elementosPorPagina, CotizacionesFiltradas.Count)
                    de @CotizacionesFiltradas.Count registros
                </span>

                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" @onclick="PaginaAnterior" disabled="@(paginaActual == 1)">
                        <i class="oi oi-arrow-left"></i> Anterior
                    </button>

                    <button type="button" class="btn btn-outline-secondary disabled">
                        Página @paginaActual de @TotalPaginas
                    </button>

                    <button type="button" class="btn btn-outline-primary" @onclick="PaginaSiguiente" disabled="@(paginaActual == TotalPaginas || TotalPaginas == 0)">
                        Siguiente <i class="oi oi-arrow-right"></i>
                    </button>

                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Cotizacion> listaCotizaciones;
    private bool cargando = true;

    // NUEVO: Variable para el término de búsqueda
    private string _terminoBusqueda = "";

    // Propiedad para reiniciar la paginación cuando se busca
    private string terminoBusqueda
    {
        get => _terminoBusqueda;
        set
        {
            if (_terminoBusqueda != value)
            {
                _terminoBusqueda = value;
                paginaActual = 1; // Reiniciamos a la pág 1 al escribir
            }
        }
    }

    // NUEVO: Propiedad calculada que filtra la lista original
    private List<Cotizacion> CotizacionesFiltradas
    {
        get
        {
            if (listaCotizaciones == null) return new List<Cotizacion>();

            if (string.IsNullOrWhiteSpace(terminoBusqueda))
            {
                return listaCotizaciones;
            }

            // Filtramos por ID (convirtiéndolo a string) o por Nombre de Cliente (ignorando mayúsculas/minúsculas)
            return listaCotizaciones.Where(c =>
                c.Id.ToString().Contains(terminoBusqueda) ||
                (c.ClienteNombre != null && c.ClienteNombre.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }
    }

    // VARIABLES DE PAGINACIÓN
    private int paginaActual = 1;
    private int elementosPorPagina = 10;

    // CAMBIO: Calculamos páginas basándonos en los resultados FILTRADOS
    private int TotalPaginas
    {
        get
        {
            if (CotizacionesFiltradas == null || CotizacionesFiltradas.Count == 0) return 1;
            return (int)Math.Ceiling((double)CotizacionesFiltradas.Count / elementosPorPagina);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            listaCotizaciones = await _cotizacionService.ObtenerHistorial();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Error al cargar el historial: " + ex.Message);
        }
        finally
        {
            cargando = false;
        }
    }

    // MÉTODOS DE CONTROL DE PAGINACIÓN
    private void PaginaSiguiente()
    {
        if (paginaActual < TotalPaginas)
        {
            paginaActual++;
        }
    }

    private void PaginaAnterior()
    {
        if (paginaActual > 1)
        {
            paginaActual--;
        }
    }

    // ... (El resto de tus métodos PrepararEnvioCorreo y DescargarPdfDesdeLista quedan igual) ...
    private async Task PrepararEnvioCorreo(Cotizacion cot)
    {
        var cotizacionCompleta = await _cotizacionService.ObtenerCotizacionPorId(cot.Id);
        var configNegocio = await _cotizacionService.ObtenerConfiguracion();
        var cliente = await _clienteService.ObtenerClientePorId(cotizacionCompleta.ClienteId);
        var pdfBytes = PdfGenerator.CrearPdfCotizacion(cotizacionCompleta, cliente, configNegocio);
        string correoDestino = await JS.InvokeAsync<string>("prompt", "Correo:", "");
        if (string.IsNullOrWhiteSpace(correoDestino)) return;

        await JS.InvokeVoidAsync("alert", "Enviando...");
        var resultado = await _emailService.EnviarCotizacionConPdf(
            correoDestino,
            cot.ClienteNombre,
            $"Cotización #{cot.Id} - {cot.ClienteNombre}",
            pdfBytes,
            cot.Id
        );

        if (resultado.Exito) await JS.InvokeVoidAsync("alert", "¡Enviado!");
        else await JS.InvokeVoidAsync("alert", "Error: " + resultado.Mensaje);
    }

    private async Task DescargarPdfDesdeLista(int idCotizacion)
    {
        try
        {
            var cotizacionCompleta = await _cotizacionService.ObtenerCotizacionPorId(idCotizacion);
            if (cotizacionCompleta == null) return;
            var configNegocio = await _cotizacionService.ObtenerConfiguracion();
            var cliente = await _clienteService.ObtenerClientePorId(cotizacionCompleta.ClienteId);
            var pdfBytes = PdfGenerator.CrearPdfCotizacion(cotizacionCompleta, cliente, configNegocio);
            using var stream = new MemoryStream(pdfBytes);
            using var streamRef = new DotNetStreamReference(stream);
            await JS.InvokeVoidAsync("downloadFileFromStream", $"Cotizacion_{idCotizacion}.pdf", streamRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.ToString());
            await JS.InvokeVoidAsync("alert", "Error al generar PDF: " + ex.Message);
        }
    }
}